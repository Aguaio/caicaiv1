{% load dict_extras %}

<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Gestión de Clientes</title>
  <style>
    .error { color: red; font-weight: bold; }
    .success { color: green; font-weight: bold; }
    .success::before { content: "✔ "; }
    table { border: 1px solid black; border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid black; padding: 5px; text-align: left; }
  </style>
</head>
<body>
  <h1>Clientes Registrados</h1>

  {% for message in messages %}
    <p class="{% if message.tags == 'error' %}error{% else %}success{% endif %}">
      {{ message }}
    </p>
  {% endfor %}

  <table>
    <tr>
      <th>Usuario</th>
      <th>Correo</th>
      <th>Dirección</th>
      <th>Teléfono</th>
      <th>Estado</th>
      <th>Acción</th>
    </tr>
    {% for c in clientes %}
    <tr>
      <td>{{ c.username }}</td>
      <td>{{ c.email }}</td>
      <td>{{ c.direccion }}</td>
      <td>{{ c.telefono }}</td>
      <td>
        {% if c.bloqueado %}
          <span style="color:red;">Bloqueado</span>
        {% else %}
          <span style="color:green;">Activo</span>
        {% endif %}
      </td>
      <td>
        {% if c.bloqueado %}
          <form action="{% url 'cliente_desbloquear' c.id %}" method="post" style="display:inline">
            {% csrf_token %}
            <button type="submit">Desbloquear</button>
          </form>
        {% else %}
          <form action="{% url 'cliente_bloquear' c.id %}" method="post" style="display:inline">
            {% csrf_token %}
            <button type="submit">Bloquear</button>
          </form>
        {% endif %}
      </td>
    </tr>
    {% empty %}
    <tr><td colspan="6">No hay clientes registrados.</td></tr>
    {% endfor %}
  </table>

  <hr>
  <h2>Historial reciente</h2>
  <table style="border-collapse:collapse; width:100%;" border="1" cellpadding="6">
    <thead>
      <tr>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Última acción</th>
        <th>Última fecha</th>
        <th>Historial</th>
      </tr>
    </thead>
    <tbody>
      {% for r in resumen %}
      <tr>
        <td>{{ r.username }}</td>
        <td>{{ r.correo }}</td>
        <td>{{ r.accion }}</td>
        <td>{% if r.fecha %}{{ r.fecha|date:"d/m/Y H:i" }}{% else %}—{% endif %}</td>
        <td>
          {% if r.tiene_historial %}
            <button class="toggle-h"
                    data-target="hist-{{ r.username|slugify }}"
                    aria-expanded="false"
                    title="Ver historial completo">▶</button>
          {% else %}
            —
          {% endif %}
        </td>
      </tr>
      <tr id="hist-{{ r.username|slugify }}" class="hist-row" style="display:none;">
        <td colspan="5">
          <table style="border-collapse:collapse; width:100%;" border="1" cellpadding="6">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Correo</th>
                <th>Acción</th>
                <th>Fecha</th>
              </tr>
            </thead>
            <tbody>
              {% for h in historial_por_cliente.r.username %}{% endfor %}
              {% for h in historial_por_cliente|get_item:r.username %}
              <tr>
                <td>{{ h.nombre }}</td>
                <td>{{ h.correo }}</td>
                <td>{{ h.accion }}</td>
                <td>{{ h.fecha|date:"d/m/Y H:i" }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <br>
  <a href="{% url 'admin_dashboard' %}">Volver al panel</a>

  <script>
    setTimeout(() => {
      document.querySelectorAll('.success, .error').forEach(el => {
        el.style.transition = 'opacity 0.5s';
        el.style.opacity = '0';
        setTimeout(() => el.remove(), 500);
      });
    }, 5000);
  </script>

  <script>
    document.querySelectorAll('.toggle-h').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-target');
        const row = document.getElementById(id);
        const open = row.style.display !== 'none';
        row.style.display = open ? 'none' : '';
        btn.textContent = open ? '▶' : '▼';
        btn.setAttribute('aria-expanded', String(!open));
      });
    });
  </script>

</body>
</html>
